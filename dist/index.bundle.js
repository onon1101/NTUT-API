(()=>{"use strict";var e={n:t=>{var r=t&&t.__esModule?()=>t.default:()=>t;return e.d(r,{a:r}),r},d:(t,r)=>{for(var s in r)e.o(r,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:r[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{default:()=>ye});const r=require("cors");var s=e.n(r);const n=require("morgan");var a=e.n(n);const o=require("express");var c=e.n(o);const i=require("mysql");var l=e.n(i);const d=require("bcrypt");var h=e.n(d);const u=require("jsonwebtoken");var p=e.n(u);const m=require("joi");var g=e.n(m);const w=require("dotenv");e.n(w)().config();const C=g().object().keys({MYSQL_PORT:g().number().default(3306),PORT:g().number().default(3e3),MYSQL_HOST:g().string().default("127.0.0.1"),NODE_ENV:g().string().default("development").allow("development","production","test","provision"),VERSION:g().string(),MYSQL_USER:g().string(),MYSQL_PASS:g().string(),MYSQL_DATABASE:g().string()}).unknown().required(),{error:y,value:f}=C.validate(process.env);if(y)throw new Error(`Config validation error: ${y.message}`);const b={port:f.PORT,node_env:f.NODE_ENV,version:f.VERSION,mysqlHost:f.MYSQL_HOST,mysqlUser:f.MYSQL_USER,mysqlPass:f.MYSQL_PASS,mysqlDatabase:f.MYSQL_DATABASE},x=require("qs");var S=e.n(x);const q=require("axios");var v=e.n(q);const O=require("iconv-lite");var P=e.n(O);const A=require("axios-retry");var T=e.n(A);const N=require("tough-cookie"),$=require("crypto");var _=e.n($);const j=require("http-cookie-agent/http"),E=Symbol("AGENT_CREATED_BY_AXIOS_COOKIEJAR_SUPPORT"),k=e=>{if(!e.jar)return e;if(!0===e.jar)throw new Error("config.jar does not accept boolean since axios-cookiejar-support@2.0.0.");const t=E;if(null!=e.httpAgent&&!0!==e.httpAgent[t]||null!=e.httpsAgent&&!0!==e.httpsAgent[t])throw new Error("axios-cookiejar-support does not support for use with other http(s).Agent.");const r={secureOptions:_().constants.SSL_OP_NO_TLSv1_2,cookies:{jar:e.jar}},s={configurable:!1,enumerable:!1,value:!0,writable:!1};return e.httpAgent=new j.HttpCookieAgent(r),e.httpsAgent=new j.HttpsCookieAgent(r),Object.defineProperty(e.httpAgent,E,s),Object.defineProperty(e.httpsAgent,E,s),e},D=new N.CookieJar,L=class{constructor(e,t){this.username=e,this.password=t,this.Axios=null,this.headers={video:{Origin:"https://nportal.ntut.edu.tw","Content-Type":"application/x-www-form-urlencoded","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/104.0.5112.102 Safari/537.36",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9","Sec-Fetch-Site":"same-site","Sec-Fetch-Mode":"navigate","Sec-Fetch-Dest":"document",Referer:"https://nportal.ntut.edu.tw/","Accept-Encoding":"gzip, deflate","Accept-Language":"en-US,en;q=0.9"},classSchedule:{"Content-Type":"application/x-www-form-urlencoded","Upgrade-Insecure-Requests":"1",Origin:"https://nportal.ntut.edu.tw","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.5735.199 Safari/537.36",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7","Sec-Fetch-Site":"same-site","Sec-Fetch-Mode":"navigate","Sec-Fetch-Dest":"document",Referer:"https://nportal.ntut.edu.tw/","Accept-Encoding":"gzip, deflate","Accept-Language":" zh-TW,zh;q=0.9,en-US;q=0.8,en;q=0.7"}}}login(){T()(v(),{retries:5,shouldResetTimeout:!0});const e=v().create({headers:this.headers.video,withCredentials:!0,maxBodyLength:1/0,baseURL:"https://nportal.ntut.edu.tw",responseType:"arraybuffer",reponseEncoding:"binary",jar:D});return(e=>{if(e.interceptors.request.handlers.find((({fulfilled:e})=>e===k)))return e;if(e.interceptors.request.use(k),"create"in e){const{create:t}=e;e.create=(...r)=>{const s=t.apply(e,r);return s.interceptors.request.use(k),s}}})(e),this.AxiosCookies=e,!0}async getPortal(){try{this.login();const e=this.AxiosCookies,t=S().stringify({muid:this.username,mpassword:this.password});return await e.post("login.do",t),this.AxiosCookies=e,!0}catch(e){return console.error(e),new Error(e)}}async getCorsClass(){try{const e=this.AxiosCookies,t=await e.get("/ssoIndex.do?apOu=aa_0010-"),r=await JSON.stringify(P().decode(t.data,"big5")).split(/['']/),s=S().stringify({sessionId:r[13],reqFrom:r[19],userid:r[25],userType:r[31]});return e.defaults.baseURL="https://aps.ntut.edu.tw/",e.defaults.headers=this.headers.classSchedule,await e.post("/course/tw/courseSID.jsp",s),this.AxiosCookies=e,!0}catch(e){throw console.error(e),new Error(e)}}async getCorsVideo(){const e=this.AxiosCookies,t=await e.get("/ssoIndex.do?apOu=ischool_plus_&sso=true&datetime1=1582549002044"),r=JSON.stringify(P().decode(t.data,"big5")).split(/['']/),s=S().stringify({sessionId:r[13],userID:r[19],username:r[25],email:r[31]});return e.defaults.baseURL="https://istudy.ntut.edu.tw/",await e.get("/login.php",s),!0}async get(...e){return new Promise(((t,r)=>{this.AxiosCookies.get(...e).then((e=>{t(P().decode(e.data,"big5"))})).catch((e=>{r(e)}))}))}},R=l().createPool({connectionlimit:10,host:b.mysqlHost,user:b.mysqlUser,password:b.mysqlPass,database:b.mysqlDatabase}),M=(e,t)=>{const r={username:t};return p().sign(r,"my_script",{expiresIn:e})};class I{constructor(){this.timeout=6e4}newUser(e){return new Promise(((t,r)=>{(async()=>{try{await(async(e,t)=>new Promise(((r,s)=>{(async()=>{try{(await new L(e,t)).getPortal(),r("登入成功!")}catch(e){s(e)}})()})))(e.username,e.password);const r={username:e.username,password:h().hashSync(e.password,10),token:M(this.timeout,e.username)};await(s=r,new Promise(((e,t)=>{R.getConnection(((r,n)=>{r?t(r):(n.query("INSERT INTO users SET ?",s,((r,s)=>{r?(console.error("SQL error:",r),t(r)):1===s.affectedRows&&e(`新增成功！ article_id: ${s.insertId}`)})),n.release())}))}))),t(r.token)}catch(e){r(e)}var s})()}))}}const U=c().Router();U.route("/").post(((e,t,r)=>{var s;(s=e.body,new Promise(((e,t)=>{(new I).newUser(s).then((t=>{e(t)})).catch((e=>{t(e)}))}))).then((e=>{t.json(e)})).catch((e=>{r(e)}))}));const Q=U,z=require("cheerio");var H=e.n(z);const Y=require("pangu");var F=e.n(Y);const W=e=>""===e?e:F().spacing(e),G=require("https");var B=e.n(G);T()(v(),{retries:5,shouldResetTimeout:!0});const K=e=>new Promise((t=>{setTimeout(t,e)})),V=(e,t=0)=>new Promise(((r,s)=>{v().request({method:"GET",url:e,responseType:"arraybuffer",reponseEncoding:"binary",timeout:6e5,httpsAgent:new(B().Agent)({secureOptions:_().constants.SSL_OP_NO_TLSv1_2})}).then((e=>{r(e)})).catch((async n=>{t<10&&(t++,await K(1e3*t*t),V(e,t).then((async e=>{r(e)})).catch((e=>{s(e)}))),s(n)}))})),J=async e=>(await K(500+500*Math.random()),new Promise(((t,r)=>{V(e).then((async e=>{t(P().decode(e.data,"big5"))})).catch((async t=>{console.error(`${new Date} GET ${e} fail. ${t}`),r(t)}))})));T()(v(),{retries:5});const X=/\n|\s|^ | $/g,Z=(e,t)=>{const r=[];return t.each(((t,s)=>{r.push({name:e(s).text().replace(X,""),link:e(s).attr("href"),code:e(s).attr("href").match(/code=(\d+)/)[1]})})),r},ee=(e,t)=>{const r=[];return t.each(((t,s)=>{r.push(e(s).attr("href"))})),r},te=(e,t)=>t.replace(X,"").split(" ").filter((e=>e.length)),re=(e,t,r)=>new Promise((s=>{s((async(e="日間部",t="109",r=2)=>{try{const s={日間部:"'1','5','6','7','8','9'",進修部:"'4','A','D','C','E','F'","研究所(日間部、進修部、週末碩士班)":"'8','9','A','C','D'"},n="",a=`https://aps.ntut.edu.tw/course/tw/QueryCourse.jsp?stime=101%2C102%2C103%2C104%2C122%2C105%2C106%2C107%2C108%2C109%2C110%2C111%2C112%2C113%2C201%2C202%2C203%2C204%2C222%2C205%2C206%2C207%2C208%2C209%2C210%2C211%2C212%2C213%2C301%2C302%2C303%2C304%2C322%2C305%2C306%2C307%2C308%2C309%2C310%2C311%2C312%2C313%2C401%2C402%2C403%2C404%2C422%2C405%2C406%2C407%2C408%2C409%2C410%2C411%2C412%2C413%2C501%2C502%2C503%2C504%2C522%2C505%2C506%2C507%2C508%2C509%2C510%2C511%2C512%2C513%2C601%2C602%2C603%2C604%2C622%2C605%2C606%2C607%2C608%2C609%2C610%2C611%2C612%2C613&year=${t}&matric=${encodeURI(P().encode(s[e],"big5"))}&sem=${r}&unit=**&cname=${n}&ccode=&tname=&D0=ON&D1=ON&D2=ON&D3=ON&D4=ON&D5=ON&D6=ON&P1=ON&P2=ON&P3=ON&P4=ON&PN=ON&P5=ON&P6=ON&P7=ON&P8=ON&P9=ON&P10=ON&P11=ON&P12=ON&P13=ON&search=%B6%7D%A9l%ACd%B8%DF`;console.log(`${new Date} GET ${a}  start.`);const o=await J(a),c=H().load(o),i=(e,t)=>c(c(t).children("td")[e]).text().replace(X,"");c("tr:first-child").remove(),c("tr:last-child").remove(),c("tr:last-child").remove(),c("tr:last-child").remove();const l=c("tr").map(((e,t)=>{let r=i(21);return r&&(r=W(r),1===r.length&&(r="")),{id:i(0,t),name:{zh:i(1,t),en:null},stage:i(2,t),credit:i(3,t),hours:i(4,t),courseType:i(5,t),class:Z(c,c(c(t).children("td")[6]).children("a")),teacher:Z(c,c(c(t).children("td")[7]).children("a")),time:{sun:te(0,c(c(t).children("td")[8]).text().trim()),mon:te(0,c(c(t).children("td")[9]).text().trim()),tue:te(0,c(c(t).children("td")[10]).text().trim()),wed:te(0,c(c(t).children("td")[11]).text().trim()),thu:te(0,c(c(t).children("td")[12]).text().trim()),fri:te(0,c(c(t).children("td")[13]).text().trim()),sat:te(0,c(c(t).children("td")[14]).text().trim())},classroom:Z(c,c(c(t).children("td")[15]).children("a")).map((e=>{const t={...e};return t.name=e.name.replace(/e$|\(e\)$/,""),t})),people:c(c(t).children("td")[16]).text().replace(X,""),peopleWithdraw:c(c(t).children("td")[17]).text().replace(X,""),ta:Z(c,c(c(t).children("td")[18]).children("a")),language:c(c(t).children("td")[19]).text().replace(X,""),notes:r,courseDescriptionLink:`https://aps.ntut.edu.tw/course/tw/${c(c(t).children("td")[1]).children("a").attr("href")}`,syllabusLinks:ee(c,c(c(t).children("td")[20]).children("a"))}})).toArray(),d=[];return await l.reduce((async(t,r,s)=>{await t;const n=await(async(e="https://aps.ntut.edu.tw/course/tw/Curr.jsp?format=-2&code=1400037")=>{const t=H().load(await J(e)),r={code:t("body > table > tbody > tr:nth-child(2) > td:nth-child(1)").text().trim().replace(X,""),name:{zh:W(t("body > table > tbody > tr:nth-child(2) > td:nth-child(2)").text().trim().replace(X,"")),en:t("body > table > tbody > tr:nth-child(2) > td:nth-child(3)").text().trim().replace(X,"")},description:{zh:W(t("body > table > tbody > tr:nth-child(3) > td:nth-child(2)").text().trim().replace(X,"")),en:t("body > table > tbody > tr:nth-child(3) > td:nth-child(3)").text().trim().replace(X,"")}};return"Nil"===r.name.en&&(r.name={zh:"",en:""}),r})(r.courseDescriptionLink);console.log(`${new Date} GET (${s}/${l.length}) ${e} - ${n.name.zh} ${r.courseDescriptionLink} finish.`);const a={...r};a.name.en=n.name.en,delete n.name,d.push({...n,...a})})),d}catch(e){return console.error(e),[]}})(r,e,t))})),se=require("cheerio-tableparser");var ne=e.n(se);const ae=/\n|^ | $/g,oe=require("express-validator"),ce=c().Router();ce.route("/:year/:semester/:department").get((async(e,t,r)=>{await(0,oe.checkSchema)({year:{isInt:!0},semester:{isInt:{errorMessage:"semester must be integer"}},department:{isString:{withMessage:"department must be string"}}}).run(e);const s=(0,oe.validationResult)(e);s.isEmpty()?r():t.send({error:s.array()})}),((e,t,r)=>{const{year:s,semester:n,department:a}=e.params;re(s,n,a).then((e=>{t.json(e)})).catch((e=>{r(e)}))})),ce.route("/years").get(((e,t,r)=>{new Promise(((e,t)=>{J("https://aps.ntut.edu.tw/course/tw/QueryCurrPage.jsp").then((t=>{const r=H().load(t),s={years:{},current:{year:r('select[name="year"] option:selected').text(),semester:r('select[name="sem"] option:selected').text()}};r('select[name="year"] option').map(((e,t)=>r(t).text())).toArray().map((e=>(e===s.current.year&&1===s.current.semester?s.years[e]=[1]:s.years[e]=[1,2],null))),e(s)})).catch((e=>{console.log(e),t()}))})).then((e=>{t.json(e)})).catch((e=>{r(e)}))})),ce.route("/departments").get(((e,t,r)=>{((e=110,t=2)=>new Promise(((r,s)=>{console.log("[fetch] 正在取得系所列表..."),J(`https://aps.ntut.edu.tw/course/tw/Subj.jsp?format=-2&year=${e}&sem=${t}`).then((async e=>{const t=[],s=H().load(e);let n=Promise.resolve();s("a").each((async(e,r)=>{n=n.then((async()=>{const n=await(async e=>new Promise(((t,r)=>{const s=[];J(`https://aps.ntut.edu.tw/course/tw/${e}`).then((e=>{const r=H().load(e);r("a").each(((e,t)=>{const n=new URL(`https://aps.ntut.edu.tw/course/tw/${r(t).attr("href")}`);s.push({id:n.searchParams.get("code"),name:r(t).text(),href:r(t).attr("href")})})),t(s)})).catch((e=>r(e)))})))(s(r).attr("href"));return t.push({name:W(s(r).text()),href:s(r).attr("href"),class:n}),console.log(`[fetch] 正在取得 (${e}/${s("a").length}) ${t[e].name}`),Promise.resolve()}))})),n.then((()=>{var e;ne()(s),(e=s("table").parsetable(!1,!0,!0))[0].map(((t,r)=>e.map((e=>e[r])))).forEach((e=>{let r=e[0].replace(ae,"");""===r&&(r="校院級"),e.forEach(((e,s)=>{0!==s&&""!==e&&e&&(t.find((t=>t.name===e)).category=r)}))})),r(t)}))})).catch((e=>{console.log(e),s(e)}))})))().then((e=>{t.json(e)})).catch((e=>{r(e)}))}));const ie=ce,le=/\n|\s|^ | $/g;class de extends L{constructor(e,t){super(e,t),this.state={}}static parseCourseTable(e){const t={mon:{},tue:{},wed:{},thu:{},fri:{},sat:{},sun:{}},r=H().load(e);r("tr:nth-child(-n+2)").remove();const s={},n=r("table:nth-child(n+4) tr:last-child").children("td");return t.totalCredit=r(n).eq(3).text(),t.totalHours=r(n).eq(4).text(),r("table:nth-child(n+4) tr").each(((e,t)=>{const n=r(t).children("td").eq(1).text().replace(le,"");s[n]={id:r(t).children("td").eq(0).text().replace(le,""),url:r(t).children("td").eq(19).find("a").attr("href"),credit:r(t).children("td").eq(3).text().replace(le,""),classroom:[],teacher:[]},r(t).children("td").eq(6).find("a").map(((e,t)=>s[n].teacher.push(r(t).text().replace(le,"")))),r(t).children("td").eq(15).find("a").map(((e,t)=>s[n].classroom.push(r(t).text().replace(le,""))))})),r("table:nth-child(2) tr:nth-child(-n+10)").each(((e,n)=>{r(n).children("td").each(((e,a)=>{const o=r(n).find("th").text().replace(le,"").substring(3),c=Object.keys(t)[e];if(t[c][o]="",r(a).find("a").length>0){const e=r(a).children("a").eq(0).text();t[c][o]={id:s[e].id,name:r(a).children("a").eq(0).text(),credit:s[e].credit,teacher:s[e].teacher,classroom:s[e].classroom,teacherDetail:`https://aps.ntut.edu.tw/course/tw/${r(a).children("a").eq(1).attr("href")}`,classSyllabus:`https://aps.ntut.edu.tw/course/tw/${s[e].url}`,classroomDetail:`https://aps.ntut.edu.tw/course/tw/${r(a).children("a").eq(2).attr("href")}`}}}))})),t}async courseTable(e,t){await this.getPortal(),await this.getCorsClass();const r={format:-2,code:this.username,year:e,sem:t},s=await this.get(`https://aps.ntut.edu.tw/course/tw/Select.jsp?format=-2&code=${this.username}&year=${e}&sem=${t}`,r);return de.parseCourseTable(s)}}const he=c().Router();he.route("/course").get((async(e,t,r)=>{new Promise(((e,t)=>{new de(usernae,passwd).courseTable(112,1).then((t=>{e(t)})).catch((e=>{console.error(e),t(e)}))})).then((e=>{t.json(e)})).catch((e=>{r(e)}))}));const ue=he,pe=c().Router();pe.get("/",((e,t)=>{t.json({message:"this path is /api"})})),pe.use("/login",Q),pe.use("/course",ie),pe.use("/personal",ue);const me=pe,ge=c()();ge.use(c().json()),ge.use(c().urlencoded({extended:!0})),ge.use(s()()),ge.use(a()("dev")),ge.get("/",((e,t)=>{t.json({message:"Hello World!"})})),ge.use("/api",me);const we=ge,Ce=new Date;we.listen(b.port,(()=>{console.log(`Server started on url http://localhost:${b.port}`)})),console.log(`NowTime: ${Ce}`);const ye={NowTime:Ce,app:we};module.exports=t})();